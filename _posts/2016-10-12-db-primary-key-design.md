---
layout:     post
title:      "数据库主键设计"
subtitle:   "每个阶段一次把事情做好才是关键"
date:       2016-10-13 14:42:00 +08:00
author:     "Sun Jianjiao <jianjiaosun@163.com>"
header-img: "img/bg/railway-station-1363771_1280.jpg"
catalog: true
tags:
    - 数据库
    - Database
    - 主键

---


数据库设计主要是对实体和关系的设计，实体就是表，关系就是外键。对于一个表，由两部分组成：主键和属性。主键是表中每一行数据的唯一标识。主键是定位到一条记录并且确保不会重复存储的逻辑机制，更方便的检索和管理数据。由于主键常常用于检索数据，被外键引用来建立表与表之间的关系，所以主键设计的好坏将会严重影响数据操作的性能。

# 主键的分类
## 业务主键
使用表中业务的字段作为主键，这种表并不多， 因为要保证该字段长久的具有行记录唯一的特点，如若有可能变成该表中的非唯一字段，那它就不适合将其变成主键。

可以**一个字段单独做主键**， 也可以多个字段组合在一起做组成**联合主键**。 

### 业务主键的好处:

- 不需要逻辑键的冗余存储，
- 可以直接根据业务主键查询一条数据
- 此业务字段不用建索引， 否则可能需要单独给业务字段建索引


## 代理主键
新增一列与业务无关的唯一性的字段做主键，也称之为“伪主键”

大多数表中的每个属性值都有可能被很多行使用。例如姓名，电子邮件地址等等都不能保证不会重复。在这样的表中，需要引入一个对于表的域模型无意义的新列来存储一个伪值。 这一列被用作这张表的主键，从而通过它来确定表中的一条记录，即其他的列允许出现适当的重复项。

### 代理主键的好处

- 消除主键（业务字段）修改引起的一致性问题 
因为业务列都有修改的可能性（比如员工号，产品编号等等），如果有其他表引用该字段作为外键，要引起级联修改。

- 消除业务主键由多个字段组成引起的冗余存储
如果业务主键由多个列组成（比如上班打卡记录，由员工号+日期组成），如果有其他表引用该表的主键做外键，需要存储多个字段，造成存储空间的扩大。

- 业务主键无法实现的情况
比如有多个字段作为主键，在应用中只有这些字段全部输入后才能保存，现实中有些功能是“保存草稿”状态的，也就是说必填字段可以在没有填写的情况下实现保存，如果不采用逻辑主键的话，此功能就无法实现。

- 传递更少的参数 
应用程序中不方便，比如像查询一个对象的明细信息，如果采用关联主键，可能需要传递多个参数才能确定一条数据（更方便地实现业务功能）

- 所有业务的字段都可以改了，即使身份证之类的。

### 常用代理主键的生成策略
#### 自增主键
数据库提供的自增数值型字段作为自增主键，它的优点是：

- 数据库自动编号，速度快，而且是增量增长，按顺序存放，对于检索非常有利；
- 数字型，占用空间小，易排序，在程序中传递也方便；
- 如果通过非系统增加记录时，可以不用指定该字段，不用担心主键重复问题。

其实它的缺点也就是来自其优点，缺点如下:  

- 因为自动增长，在手动要插入指定ID的记录时会显得麻烦，尤其是当系统与其它系统集成时，需要数据导入时，很难保证原系统的ID不发生主键冲突（前提是老系统也是数字型的）。特别是在新系统上线时，新旧系统并行存在，并且是异库异构的数据库的情况下，需要双向同步时，自增主键将是你的噩梦；
- 在系统集成或割接时，如果新旧系统主键不同是数字型就会导致修改主键数据类型，这也会导致其它有外键关联的表的修改，后果同样很严重；
- 若系统也是数字型的，在导入时，为了区分新老数据，可能想在老数据主键前统一加一个字符标识（例如“o”，old）来表示这是老数据，那么自动增长的数字型又面临一个挑战。

MySQL（auto_increment）、SQL Server（IDENTITY）、Informix、Oracle（首先创建自增序列，接着为自增主键的表创建插入时的触发器，给自增主键ID赋值）等数据库都支持这种自增主键，这种主键在各种系统中应用广泛。
但是如果考虑到有新旧系统并存等问题，为了避免不必要的麻烦，使用自增主键要三思。

#### UUID主键

能够在网络环境中生成唯一的一个32位16进制数字的字符串，跨数据库，不用访问数据库就能生成主键，所以效率高且能保证唯一性，移植非常方便；

主要优点是：

- 生成管理方便——完全由算法自动生成，不需要一个权威机构来管理，在空间上和时间上具有唯一性，保证同一时间不同地方产生的数字不同。
- 系统集成方便———世界上的任何两台计算机都不会生成重复的UUID值，　所以几个系统的UUID值导到一起时，也不会发生重复。
- 数据库移植方便——UUID列可以作为字符型列转换到其它数据库中，同时将应用程序中产生的UUID值存入数据库，不会对原有数据带来影响。
- UUID的长度固定，并且相对而言较短小，非常适合于排序、标识和存储。

缺点是：

- UUID值较长，不容易记忆和输入，而且这个值是随机、无顺序的。
- UID的值有16个字节，与其它诸如4字节的整数相比要相对大一些。这意味着如果在数据库中使用键，可能会带来两方面的消极影响：存储空间增大、索引时间会慢一些。

基于上面的分析，使用UUID的利大于弊，推荐可以采用此种方式

#主键选择

规则 	自然键 	代理键
主键必须唯一的识别每一记录 	但与输入和人为错误有关 	系统自生成的数据是唯一的
一个记录的主键不能为空 	只有数据可知时才能输入记录 	当记录生成时才被系统建立
当生成记录时，主键的值必须存在 	只有数据可知时才能输入记录 	当记录生成时才被系统建立当记录生成时才被系统建立
主键必须保持稳定——你不能更改主键的域 	自然键与一些商业规则和其他外部影响有关 	代理键对程序功能和数据保持中立
主键必须简洁，不要包含过分的属性 	一个自然键可以包含多个域 	代理键只能包含多个域
主键的值不能改变 	自然键通常改变 	代理键通常

## 单一字段业务主键
字段肯定唯一，并且不会改变的字段适合使用业务主键。　例如“用户信息表”的“用户登录名”字段基本都是唯一的，而且几乎不可能变成一个登录名对应两条记录，因此可以使用其作为主键。另外，例如“一号通用户信息表”中，“一号通号码”肯定是唯一的，因此也可作为主键。

**下面情况尽量不要作为主键**

- 业务字段是用户从系统录入的，建议不要作为主键，　不要信任用户的任何输入，只要是用户自己录入的，那么就很有可能录错了，如果发现录入错误，这个时候再对主键进行修改，将会涉及到大量关联的外键表的修改，是很麻烦的一件事情。比如在做人员表的时候，就不要身份证号做主键。

- 不是自己控制的不要作为主键。例如身份证号可以确定一个人的身份，但是不能用来把他作为主键。假设有一张人员表，还有100张表关联到这张表。假如用身份证做主键，前几年升级身份证，15位变18位，那么你有101个字段需要重新设置，每修改一个人员的身份证号码，就要附带更新100张表。


## 联合主键
多对多的中间表（关联表），不需要为中间的关联建立实体，所以中间表可能就只需要两列，分别是两个实体表的主键。创建仅仅为了方便区别其他数据，保证取出的数据的正确性，联合主键是一个不错的选择。　但是如果会被其他表作为外键，　建议还是使用代理主键。
　
## 代理主键
代理主键是较为常用的方式，　基本上除了上面的情况，　都会使用代理主键。　考虑到可移植性的情况UUID用的较多。

增加一个代理主键，看似多存储了一个字段，表面上看称之为冗余，但是你再进一步，加入有其他表引用这个主键作为外键，同时要存储两个字段的（外键），那么上面的冗余反而是节省了空间


